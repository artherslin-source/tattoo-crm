# 刺青工作室 CRM 系統 — 系統安裝上線說明

本說明以**在伺服器或雲端平台（如 Zeabur、Railway）上部署**為情境，提供從解壓套件到正式上線的步驟。

---

## 一、環境需求

部署平台需支援：

| 項目 | 需求 |
|------|------|
| 執行環境 | **Node.js** 18.x 或 20.x（LTS）；Zeabur、Railway 等會自動提供 |
| 套件管理 | **npm**（隨 Node 提供） |
| 資料庫 | **PostgreSQL**（正式環境必備；請在平台新增 PostgreSQL 服務） |

若您先在**本機**建置再上傳，本機需安裝 Node.js 18+ 與 npm；資料庫仍建議使用平台提供的 PostgreSQL。

---

## 二、取得並解壓套件

1. 取得交付的壓縮檔（例如 `tattoo-crm-customer-delivery-YYYYMMDD.tar.gz`）。
2. 解壓至欲使用的目錄（可於本機解壓後上傳至 Git／雲端，或於本機建置後再部署）：
   ```bash
   tar -xzf tattoo-crm-customer-delivery-YYYYMMDD.tar.gz
   cd tattoo-crm
   ```
3. 確認目錄結構包含：
   - `backend/` — 後端程式
   - `frontend/` — 前端程式
   - `安裝與設定/` — 內含網址替換腳本與本說明

---

## 三、第一步：執行網址替換（必做）

套件內預設為開發/示範用網址。**上線前必須**改為您自己的後端與前端網址，否則資料可能誤傳至開發站。

1. 在專案根目錄（與 `backend`、`frontend` 同層）執行：
   ```bash
   node 安裝與設定/替換網址.js
   ```
2. 依提示輸入：
   - **後端 API 網址**：例如 `https://api.yourdomain.com`（對外提供 API 的網址）
   - **前端網站網址**：例如 `https://www.yourdomain.com`（使用者開啟的網站）
3. 確認顯示的替換結果後輸入 `y` 執行。
4. 腳本會更新：
   - 前端的 `next.config.ts`、API 與預約頁的網址邏輯
   - 前端的 `.env.local.example`、後端的 `.env.example` 範例

**注意**：請以實際上線後會使用的後端與前端網址輸入；若部署後網址有變，請再執行一次並重新建置前端。

---

## 四、後端安裝與設定

部署於 Zeabur、Railway 等平台時，後端通常以 **根目錄 = `backend`** 建立服務，由平台執行 `npm install`、`npm run build`、`npm run start:prod`。以下為需設定的重點。

### 4.1 安裝依賴

由部署平台在建置階段執行（多數會自動執行 `npm install`）。若在本機建置，請在 `backend` 目錄執行：

```bash
cd backend
npm install
```

### 4.2 環境變數

請在**部署平台的「環境變數」或「Variables」**中設定（勿將密鑰提交至程式碼）：

| 變數 | 說明 | 範例 |
|------|------|------|
| DATABASE_URL | PostgreSQL 連線字串（必填） | 由 Zeabur／Railway 的 PostgreSQL 服務提供，格式如 `postgresql://user:pass@host:5432/dbname` |
| JWT_ACCESS_SECRET | JWT 存取密鑰（請自訂長字串） | 至少 32 字元 |
| JWT_REFRESH_SECRET | JWT 更新密鑰（請自訂） | 至少 32 字元 |
| PORT | 後端監聽埠 | 可留空，由平台指派 |
| CORS_ORIGIN | 允許的前端網址，多個用逗號分隔 | 您的前端實際上線網址，例如 `https://您的專案.zeabur.app` |

若已執行「網址替換」腳本，`.env.example` 會含建議的 `CORS_ORIGIN`，可作為設定參考。

### 4.3 資料庫

- **遷移**：後端首次啟動時（`npm run start:prod`）會自動執行 `npx prisma generate` 與 `npx prisma migrate deploy`，建立資料表。
- **初始資料**：遷移完成後，請在**部署平台提供的執行介面**（或連線至後端環境）執行一次，匯入分店、管理員與 6 位刺青師，否則後台無刺青師可登入：
  ```bash
  npx prisma db execute --file prisma/seed-data.sql
  ```
  若平台無法執行上述指令，可於本機使用 Zeabur／Railway 提供的 PostgreSQL 連線字串執行：
  ```bash
  psql "$DATABASE_URL" -f backend/prisma/seed-data.sql
  ```
  匯入後即具備：
  - **分店**：三重店、東港店
  - **管理員**：`admin@test.com` / 手機 `0988666888` / 密碼 `12345678`
  - **刺青師**（6 位）：朱川進×2、陳翔男、黃晨洋、林承葉、陳震宇（密碼皆 `12345678`）
  上線後請儘快於後台修改密碼或新增真實帳號。

### 4.4 啟動後端

於伺服器／雲端部署時，請將**建置指令**設為 `npm run build`、**啟動指令**設為 `npm run start:prod`（平台會依此執行）。後端會由平台分配對外網址與埠，請將該網址設為前端的 `NEXT_PUBLIC_API_URL`。

---

## 五、前端安裝與設定

部署時前端通常以**根目錄 = `frontend`** 建立服務，由平台執行 `npm install`、`npm run build`、`npm run start`。

### 5.1 安裝依賴

由部署平台在建置階段執行。若在本機建置，請在 `frontend` 目錄執行 `npm install`。

### 5.2 環境變數

請在**部署平台的環境變數**中設定（建置時會寫入前端）：

| 變數 | 說明 | 範例 |
|------|------|------|
| NEXT_PUBLIC_API_URL | 後端 API 完整網址 | 後端在 Zeabur／Railway 分配到的網址，例如 `https://xxx.zeabur.app` |
| NEXT_PUBLIC_BACKEND_URL | 與上同（部分功能會讀此變數） | 同上 |

**重要**：建置前務必已執行「網址替換」且上述變數為實際上線的後端網址，否則前端會把請求送到錯誤的網址。

### 5.3 建置與啟動

於伺服器／雲端部署時，請將**建置指令**設為 `npm run build`、**啟動指令**設為 `npm run start`。平台會為前端分配對外網址。

---

## 六、驗證安裝

1. **後端**：以平台分配之後端網址開啟 `/health/simple`（例如 `https://您的後端.zeabur.app/health/simple`），應回傳正常。
2. **前端**：以平台分配之前端網址開啟網站，應能進入首頁；登入後可操作後台。
3. **連通性**：在前台進行登入、預約等操作，確認請求皆指向您的後端網址（可從瀏覽器開發者工具 Network 檢查請求網址）。

---

## 七、部署上線建議

### 7.1 後端（Railway、Zeabur、自架主機等）

- 設定 `DATABASE_URL` 為正式 PostgreSQL（建議）。
- 設定 `JWT_ACCESS_SECRET`、`JWT_REFRESH_SECRET` 為強密鑰，且勿提交至版控。
- 設定 `CORS_ORIGIN` 為正式前端網址（可含多個，逗號分隔）。
- 若使用反向代理（Nginx、Cloudflare 等），依需求設定 `TRUST_PROXY_HOPS`。

### 7.2 前端（Vercel、Zeabur、自架、同一主機等）

- 建置前確認 `NEXT_PUBLIC_API_URL`、`NEXT_PUBLIC_BACKEND_URL` 為正式後端網址。
- 部署後確認「登入、預約、上傳」等請求皆指向正式後端，而非開發站。

### 7.3 部署於 Zeabur（含 GitHub 無縫轉移）

本系統為 **Node.js 後端（NestJS）+ Next.js 前端 + PostgreSQL**，Zeabur 皆支援。**若要以 GitHub 一鍵部署／無縫轉移**，請直接依 **[Zeabur 部署指南](./Zeabur部署指南.md)** 操作。以下為摘要步驟：

1. **建立專案與資料庫**  
   在 Zeabur 建立新專案，新增 **PostgreSQL** 服務（Zeabur 會提供連線字串）。

2. **後端服務**  
   - 新增服務，來源選擇「上傳程式碼」或連到已上傳的套件（解壓後的目錄）。  
   - **根目錄（Root Directory）** 設為 **`backend`**。  
   - 環境變數：`DATABASE_URL`（連結到剛建立的 PostgreSQL）、`JWT_ACCESS_SECRET`、`JWT_REFRESH_SECRET`、`PORT`（可留空，由 Zeabur 指派）、`CORS_ORIGIN`（您的前端網址，例如 `https://您的專案.zeabur.app`）。  
   - 建置指令通常會自動偵測（`npm install`、`npm run build`）；若需自訂，可設為 `npm run build`（後端會執行 Prisma generate 與 Nest 建置）。  
   - 啟動指令：`npm run start:prod`（會執行 Prisma 遷移後啟動）。

3. **前端服務**  
   - 再新增一個服務，根目錄設為 **`frontend`**。  
   - 環境變數：`NEXT_PUBLIC_API_URL`、`NEXT_PUBLIC_BACKEND_URL` 設為後端對外網址（Zeabur 會為後端服務分配網址）。  
   - 建置：`npm run build`；啟動：`npm run start`。

4. **初始資料**  
   後端首次啟動會自動執行資料庫遷移。**刺青師等初始資料**需在 Zeabur 後台對後端服務執行一次：  
   `npx prisma db execute --file prisma/seed-data.sql`  
   若平台不支援執行指令，可於本機用 `psql` 連到 Zeabur 提供的 PostgreSQL 連線字串，執行 `psql "$DATABASE_URL" -f backend/prisma/seed-data.sql`。

5. **網址替換**  
   部署前請先執行 `node 安裝與設定/替換網址.js`，將後端與前端網址改為 Zeabur 分配之網址（或您的自訂網域），再建置與部署。

### 7.4 網址與 CORS

- 後端需允許前端網址的 CORS；前端需知道後端完整網址。
- 若上線網址與安裝時輸入不同，請再次執行 `node 安裝與設定/替換網址.js` 並重新建置前端。

（以上 7.1～7.4 適用 Railway、Zeabur、Vercel、自架主機等；技術棧為標準 Node.js + Next.js + PostgreSQL，無廠商鎖定。）

---

## 八、常見問題

**Q：上線後沒有刺青師帳號、資料庫查不到可登入的刺青師？**  
請確認已依 4.3 在 `npx prisma migrate deploy` 之後執行 `npx prisma db execute --file prisma/seed-data.sql`（或 `psql "$DATABASE_URL" -f prisma/seed-data.sql`）匯入套件內附的初始資料。該 SQL 已包含與 Railway 一致的 6 位刺青師。完成後請儘快於後台修改密碼。

**Q：忘記執行網址替換就上線了怎麼辦？**  
請重新執行 `node 安裝與設定/替換網址.js`，輸入正式後端與前端網址，然後重新建置前端並部署。

**Q：後端 CORS 錯誤，前端無法呼叫 API。**  
檢查後端 `.env` 的 `CORS_ORIGIN` 是否包含前端實際使用的網址（含協定與埠，例如 `https://www.yourdomain.com`）。

**Q：前端建置後仍連到舊網址。**  
確認已執行網址替換、`.env.local` 為正式後端網址，且執行的是 `npm run build`（不是僅 `npm run dev`）。建置完成後再部署產出的檔案。

**Q：可否只用 SQLite 上線？**  
正式營運建議使用 PostgreSQL；SQLite 較不適合雲端多機與高併發。

**Q：如何備份資料？**  
使用平台提供的備份功能，或以 `pg_dump` 等工具對 PostgreSQL 定期排程備份。

---

## 九、聯絡與支援

若安裝或上線過程遇到問題，請保留錯誤訊息與操作步驟，與開發團隊聯絡以利排查。
