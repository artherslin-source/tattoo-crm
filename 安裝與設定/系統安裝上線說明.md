# 刺青工作室 CRM 系統 — 系統安裝上線說明

本說明提供從解壓套件到正式上線的完整步驟，請依序操作。

---

## 一、環境需求

在開始前請確認安裝：

| 項目 | 需求 |
|------|------|
| Node.js | 18.x 或 20.x（建議 LTS） |
| npm | 隨 Node 安裝即可 |
| 資料庫 | 開發可先用 **SQLite**；正式環境建議 **PostgreSQL** |

若尚未安裝 Node.js，請至 [https://nodejs.org](https://nodejs.org) 下載 LTS 版本。

---

## 二、取得並解壓套件

1. 取得交付的壓縮檔（例如 `tattoo-crm-customer-delivery-YYYYMMDD.tar.gz`）。
2. 在欲安裝的目錄解壓：
   ```bash
   tar -xzf tattoo-crm-customer-delivery-YYYYMMDD.tar.gz
   cd tattoo-crm
   ```
3. 確認目錄結構包含：
   - `backend/` — 後端程式
   - `frontend/` — 前端程式
   - `安裝與設定/` — 內含網址替換腳本與本說明

---

## 三、第一步：執行網址替換（必做）

套件內預設為開發/示範用網址。**上線前必須**改為您自己的後端與前端網址，否則資料可能誤傳至開發站。

1. 在專案根目錄（與 `backend`、`frontend` 同層）執行：
   ```bash
   node 安裝與設定/替換網址.js
   ```
2. 依提示輸入：
   - **後端 API 網址**：例如 `https://api.yourdomain.com`（對外提供 API 的網址）
   - **前端網站網址**：例如 `https://www.yourdomain.com`（使用者開啟的網站）
3. 確認顯示的替換結果後輸入 `y` 執行。
4. 腳本會更新：
   - 前端的 `next.config.ts`、API 與預約頁的網址邏輯
   - 前端的 `.env.local.example`、後端的 `.env.example` 範例

**注意**：若尚未決定正式網址，可先跳過此步，用 `localhost` 在本機測試；正式上線前務必再執行一次並輸入實際上線網址。

---

## 四、後端安裝與設定

### 4.1 安裝依賴

```bash
cd backend
npm install
```

### 4.2 環境變數

1. 複製範例檔：
   ```bash
   cp .env.example .env
   ```
2. 編輯 `.env`，至少設定：

   | 變數 | 說明 | 範例 |
   |------|------|------|
   | DATABASE_URL | 資料庫連線字串 | SQLite: `file:./prisma/dev.db`<br>PostgreSQL: `postgresql://user:pass@host:5432/dbname` |
   | JWT_ACCESS_SECRET | JWT 存取密鑰（請自訂長字串） | 至少 32 字元 |
   | JWT_REFRESH_SECRET | JWT 更新密鑰（請自訂） | 至少 32 字元 |
   | PORT | 後端監聽埠 | 4000 |
   | CORS_ORIGIN | 允許的前端網址，多個用逗號分隔 | 您的前端網址 + `http://localhost:3000`（本機開發用） |

若已執行「網址替換」腳本，`.env.example` 中的 `CORS_ORIGIN` 會含您的前端網址，可一併複製到 `.env` 後再調整。

### 4.3 資料庫

```bash
npx prisma generate
npx prisma migrate deploy
```

- 第一次會依 `prisma/schema.prisma` 建立資料表。
- 若需初始資料（分店、管理員等），可再執行：`node seed.js`（依專案是否有提供 seed 而定）。

### 4.4 啟動後端

- 開發模式：`npm run start:dev`
- 正式模式：`npm run build` 後 `npm run start`

確認無誤時，後端會在本機 `http://localhost:4000` 提供 API（或您設定的 PORT）。

---

## 五、前端安裝與設定

### 5.1 安裝依賴

```bash
cd frontend
npm install
```

### 5.2 環境變數

1. 複製範例檔：
   ```bash
   cp .env.local.example .env.local
   ```
2. 編輯 `.env.local`，至少設定：

   | 變數 | 說明 | 範例 |
   |------|------|------|
   | NEXT_PUBLIC_API_URL | 後端 API 完整網址 | `https://api.yourdomain.com` |
   | NEXT_PUBLIC_BACKEND_URL | 與上同（部分功能會讀此變數） | 同上 |

若已執行「網址替換」腳本，`.env.local.example` 會預填您輸入的後端網址，可參考後複製到 `.env.local`。

### 5.3 建置與啟動

- 開發模式：`npm run dev`（預設 `http://localhost:3000`）
- 正式模式：
  ```bash
  npm run build
  npm run start
  ```

**重要**：部署到正式環境時，建置必須在「已替換網址」且「.env.local 為正式後端網址」的狀態下執行，否則前端會把請求送到錯誤的網址。

---

## 六、驗證安裝

1. **後端**：瀏覽器或 curl 開啟 `http://localhost:4000/health/simple`（或您設定的 PORT），應回傳正常。
2. **前端**：開啟 `http://localhost:3000`，應能進入首頁；登入後可操作後台。
3. **連通性**：在前台進行登入、預約等操作，確認請求皆指向自己的後端（可從瀏覽器開發者工具 Network 檢查請求網址）。

---

## 七、部署上線建議

### 7.1 後端（例如 Railway、自架主機）

- 設定 `DATABASE_URL` 為正式 PostgreSQL（建議）。
- 設定 `JWT_ACCESS_SECRET`、`JWT_REFRESH_SECRET` 為強密鑰，且勿提交至版控。
- 設定 `CORS_ORIGIN` 為正式前端網址（可含多個，逗號分隔）。
- 若使用反向代理（Nginx、Cloudflare 等），依需求設定 `TRUST_PROXY_HOPS`。

### 7.2 前端（例如 Vercel、自架、同一主機）

- 建置前確認 `NEXT_PUBLIC_API_URL`、`NEXT_PUBLIC_BACKEND_URL` 為正式後端網址。
- 部署後確認「登入、預約、上傳」等請求皆指向正式後端，而非開發站。

### 7.3 網址與 CORS

- 後端需允許前端網址的 CORS；前端需知道後端完整網址。
- 若上線網址與安裝時輸入不同，請再次執行 `node 安裝與設定/替換網址.js` 並重新建置前端。

---

## 八、常見問題

**Q：忘記執行網址替換就上線了怎麼辦？**  
請在伺服器或本機重新執行 `node 安裝與設定/替換網址.js`，輸入正式後端與前端網址，然後重新建置前端並部署。

**Q：後端 CORS 錯誤，前端無法呼叫 API。**  
檢查後端 `.env` 的 `CORS_ORIGIN` 是否包含前端實際使用的網址（含協定與埠，例如 `https://www.yourdomain.com`）。

**Q：前端建置後仍連到舊網址。**  
確認已執行網址替換、`.env.local` 為正式後端網址，且執行的是 `npm run build`（不是僅 `npm run dev`）。建置完成後再部署產出的檔案。

**Q：可否只用 SQLite 上線？**  
可，但 SQLite 較不適合高併發與多機部署；正式營運建議使用 PostgreSQL。

**Q：如何備份資料？**  
依使用資料庫類型：SQLite 可複製 `prisma/dev.db`；PostgreSQL 請使用 `pg_dump` 等工具。建議定期排程備份。

---

## 九、聯絡與支援

若安裝或上線過程遇到問題，請保留錯誤訊息與操作步驟，與開發團隊聯絡以利排查。
