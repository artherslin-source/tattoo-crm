# Toggle 按鈕使用指南

**更新日期：** 2025-01-05  
**狀態：** ✅ **完全修復並改進**

---

## 🎯 Toggle 按鈕的作用

Toggle 按鈕用於**控制規格是否在前端顯示給顧客**。

### 重要概念

**按鈕顯示的是「當前狀態」，點擊後會「切換到相反狀態」。**

---

## 🎨 按鈕外觀說明

### 綠色按鈕「已啟用」

```
┌──────────────────┐
│ ➡️ 已啟用       │  ← 綠色背景，綠色文字，加粗
└──────────────────┘
```

**含義：**
- **當前狀態：** 規格已啟用
- **顧客可見：** 顧客在前端能看到並選擇此規格
- **點擊後：** 規格會被停用，顧客將看不到此選項

**使用時機：**
- 當您想要**停用**某個規格時，點擊綠色「已啟用」按鈕

---

### 灰色按鈕「已停用」

```
┌──────────────────┐
│ ⬅️ 已停用       │  ← 灰色背景，灰色文字，加粗
└──────────────────┘
```

**含義：**
- **當前狀態：** 規格已停用
- **顧客不可見：** 顧客在前端看不到此規格
- **點擊後：** 規格會被啟用，顧客將能看到並選擇

**使用時機：**
- 當您想要**啟用**某個規格時，點擊灰色「已停用」按鈕

---

## 📱 完整操作流程

### 場景 1：停用某個規格

**需求：** 暫時不想讓顧客選擇「5-6cm」尺寸

**操作步驟：**

1. **進入管理後台** → 服務管理
2. **點擊「管理規格」**（紫色按鈕）
3. **找到「5-6cm」規格**
4. **查看按鈕狀態：**
   ```
   5-6cm [S1] [必選] [✓ 啟用中]
   價格：2000元
                    [🟢 已啟用] [編輯] [🗑️]
   ```
5. **點擊綠色「已啟用」按鈕**
6. **看到更新過程：**
   ```
   [⏳ 更新中...] [編輯] [🗑️]
   ```
7. **更新完成後：**
   ```
   5-6cm [S1] [必選] [✗ 已停用]
   價格：2000元
   (卡片背景變為灰色)
                    [⚪ 已停用] [編輯] [🗑️]
   ```

**結果：**
- ✅ 規格已停用
- ✅ 顧客在前端看不到「5-6cm」選項
- ✅ 規格選擇器只顯示其他 11 個尺寸

---

### 場景 2：啟用某個規格

**需求：** 重新開放「5-6cm」尺寸選項

**操作步驟：**

1. **進入管理後台** → 服務管理 → 管理規格
2. **找到停用的「5-6cm」規格**
   ```
   5-6cm [S1] [必選] [✗ 已停用]
   價格：2000元
   (灰色背景)
                    [⚪ 已停用] [編輯] [🗑️]
   ```
3. **點擊灰色「已停用」按鈕**
4. **看到更新過程：**
   ```
   [⏳ 更新中...] [編輯] [🗑️]
   ```
5. **更新完成後：**
   ```
   5-6cm [S1] [必選] [✓ 啟用中]
   價格：2000元
   (白色背景)
                    [🟢 已啟用] [編輯] [🗑️]
   ```

**結果：**
- ✅ 規格已啟用
- ✅ 顧客在前端能看到「5-6cm」選項
- ✅ 規格選擇器顯示完整 12 個尺寸

---

## 🔍 如何確認 Toggle 是否生效

### 方法 1：檢查規格管理界面

**停用後：**
- 按鈕變為灰色「已停用」
- 狀態 Badge 顯示「✗ 已停用」
- 卡片背景變為灰色（bg-gray-50）

**啟用後：**
- 按鈕變為綠色「已啟用」
- 狀態 Badge 顯示「✓ 啟用中」
- 卡片背景變為白色（bg-white）

### 方法 2：檢查前端顧客端

1. **打開前端首頁**
2. **點擊任一服務的「加入購物車」**
3. **查看規格選擇器：**
   - 停用的規格不會顯示
   - 啟用的規格正常顯示

**範例：**

**停用「5-6cm」前：**
```
尺寸選項（12 個）：
[5-6cm] [6-7cm] [7-8cm] ... [16-17cm]
```

**停用「5-6cm」後（重新打開規格選擇器）：**
```
尺寸選項（11 個）：
[6-7cm] [7-8cm] [8-9cm] ... [16-17cm]
（5-6cm 不顯示）✅
```

---

## 🐛 調試功能

### 控制台日誌

**新版本添加了詳細的調試日誌**，打開瀏覽器控制台（F12）可以看到：

**點擊 Toggle 按鈕時：**
```
[VariantManager] 切換規格: cmhlh1znm0007jw8uns3kphcf, 當前狀態: true, 目標狀態: false
[VariantManager] API URL: https://tattoo-crm-production-413f.up.railway.app/admin/service-variants/cmhlh1znm0007jw8uns3kphcf
[VariantManager] 發送數據: { isActive: false }
[VariantManager] 響應狀態: 200
[VariantManager] 更新成功: { id: "...", name: "5-6cm", isActive: false }
```

**如果出現錯誤：**
```
[VariantManager] 響應狀態: 401
[VariantManager] 更新失敗: Unauthorized
```

### 錯誤提示

**成功更新：**
- 按鈕狀態立即改變
- 沒有彈出 alert

**更新失敗：**
- 彈出 alert：「更新失敗: 401 Unauthorized」
- 或：「更新失敗，請重試。請檢查網路連接或查看控制台錯誤。」
- 按鈕狀態不變

---

## 🎯 最佳實踐

### 規格啟用/停用策略

**建議啟用：**
- 常用的尺寸（例如：8-9cm, 9-10cm, 10-11cm）
- 兩種顏色（黑白、彩色）
- 常見部位（例如：手臂外側、小腿）
- 設計費

**可考慮停用：**
- 極小或極大的尺寸（如果不常用）
- 特殊部位（如果該服務不適用）
- 暫時缺貨或不提供的規格

### 操作建議

1. **測試切換：**
   - 先在測試服務上試用
   - 確認前端顯示正確
   - 再套用到正式服務

2. **保留常用選項：**
   - 至少保留 5-8 個尺寸選項
   - 保留黑白和彩色兩種顏色
   - 根據服務類型調整部位

3. **分批調整：**
   - 不要一次停用太多規格
   - 觀察顧客反應和訂單數據
   - 根據需求逐步調整

---

## ❓ 常見問題

### Q1: 點擊 Toggle 按鈕後沒有反應？

**解決方法：**

1. **打開控制台（F12）查看日誌**
   - 看是否有錯誤訊息
   - 檢查 API 響應狀態

2. **檢查是否已登入**
   - Toggle 功能需要管理員權限
   - 如果 token 過期，請重新登入

3. **清除瀏覽器緩存**
   - 強制重新整理（Ctrl+Shift+R 或 Cmd+Shift+R）
   - 關閉規格管理器後重新打開

4. **檢查網路連接**
   - 確保能連接到後端 API
   - 檢查是否有防火牆阻擋

### Q2: 前端還是顯示停用的規格？

**解決方法：**

1. **關閉規格選擇器後重新打開**
   - 規格選擇器有 `cache: 'no-store'` 設定
   - 重新打開會強制刷新

2. **清除瀏覽器緩存**
   - 有時瀏覽器會緩存 API 響應
   - 清除緩存或使用無痕模式測試

3. **確認規格確實已停用**
   - 在管理後台檢查規格狀態
   - 看是否顯示「✗ 已停用」Badge

### Q3: Toggle 按鈕變為灰色且無法點擊？

**原因：** 正在更新中（`updating` 狀態）

**解決方法：**

1. **等待更新完成**
   - 通常只需 1-2 秒
   - 按鈕會自動恢復可點擊狀態

2. **如果一直卡住：**
   - 關閉規格管理器
   - 重新打開
   - 檢查控制台錯誤訊息

### Q4: 停用規格後會影響已下訂單嗎？

**答案：不會！**

- 停用規格只影響**新的訂單**
- 已下的訂單和預約完全不受影響
- 購物車中的項目也不受影響（使用 cartSnapshot）

---

## 🔧 技術細節

### 前端實現

**VariantManager.tsx:**

```typescript
// 切換啟用/停用
const toggleActive = async (variantId: string, currentActive: boolean) => {
  console.log(`切換規格: ${variantId}, 當前狀態: ${currentActive}, 目標狀態: ${!currentActive}`);
  
  setUpdating(variantId); // 設置更新中狀態
  
  try {
    const response = await fetch(`${API}/admin/service-variants/${variantId}`, {
      method: "PATCH",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${getAccessToken()}`,
      },
      body: JSON.stringify({ isActive: !currentActive }), // 切換狀態
    });

    if (response.ok) {
      await fetchVariants(); // 重新獲取規格
      onUpdate(); // 通知父組件
    }
  } catch (error) {
    alert("更新失敗，請重試");
  } finally {
    setUpdating(null); // 清除更新中狀態
  }
};
```

### 後端 API

**Endpoint:** `PATCH /admin/service-variants/:id`

**請求：**
```json
{
  "isActive": false  // true 或 false
}
```

**響應：**
```json
{
  "id": "cmhlh1znm0007jw8uns3kphcf",
  "name": "5-6cm",
  "isActive": false,
  "priceModifier": 2000,
  "sortOrder": 1,
  // ... 其他欄位
}
```

### 公開 API 過濾

**Endpoint:** `GET /services/:id/variants`

**特點：**
- 自動過濾 `isActive: false` 的規格
- 只返回啟用的規格給顧客
- 管理端 API 可以看到所有規格

**範例：**

**管理端 API（所有規格）：**
```
GET /admin/service-variants/service/:serviceId
→ 返回 12 個尺寸（包含停用的）
```

**公開 API（只有啟用的）：**
```
GET /services/:serviceId/variants
→ 返回 11 個尺寸（不包含停用的）
```

---

## 📊 視覺對比

### 啟用狀態

**管理後台：**
```
┌─────────────────────────────────────────────┐
│ 5-6cm [S1] [必選] [✓ 啟用中]               │
│ 價格：2000元                                │
│ 5-6cm（黑白2000/彩色3000）                 │
│                                              │
│ [🟢 已啟用] [編輯] [🗑️]                    │
│  ↑ 綠色背景                                 │
└─────────────────────────────────────────────┘
```

**前端規格選擇器：**
```
尺寸選項：
┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐
│5-6cm│ │6-7cm│ │7-8cm│ │8-9cm│  ← 5-6cm 顯示 ✅
└─────┘ └─────┘ └─────┘ └─────┘
```

---

### 停用狀態

**管理後台：**
```
┌─────────────────────────────────────────────┐
│ 5-6cm [S1] [必選] [✗ 已停用]               │
│ 價格：2000元                                │
│ 5-6cm（黑白2000/彩色3000）                 │
│ (卡片背景為灰色)                            │
│                                              │
│ [⚪ 已停用] [編輯] [🗑️]                    │
│  ↑ 灰色背景                                 │
└─────────────────────────────────────────────┘
```

**前端規格選擇器：**
```
尺寸選項：
┌─────┐ ┌─────┐ ┌─────┐
│6-7cm│ │7-8cm│ │8-9cm│  ← 5-6cm 不顯示 ✅
└─────┘ └─────┘ └─────┘
（只有 11 個選項）
```

---

## ✅ 修復確認

### 問題修復清單

- [x] 「前手臂」服務初始化完整規格（21 個）
- [x] 「上下手臂全肢」服務規格修正（11 → 21 個）
- [x] Toggle 按鈕文字改為「已啟用」/「已停用」
- [x] 添加詳細的控制台日誌
- [x] 改進錯誤提示訊息
- [x] 更新說明文字，解釋按鈕作用
- [x] 後端 API 測試通過
- [x] 前端同步測試通過

### 功能驗證

- [x] 停用規格 → 管理端顯示「已停用」
- [x] 停用規格 → 公開 API 過濾正確
- [x] 停用規格 → 前端不顯示該規格
- [x] 啟用規格 → 管理端顯示「已啟用」
- [x] 啟用規格 → 公開 API 包含該規格
- [x] 啟用規格 → 前端顯示該規格

---

## 🚀 立即測試

### 測試步驟

1. **訪問管理後台：**
   https://tattoo-crm-production.up.railway.app/admin/services

2. **點擊任一服務的「管理規格」**

3. **觀察 Toggle 按鈕：**
   - 綠色「已啟用」或灰色「已停用」
   - 文字清楚顯示

4. **點擊 Toggle 按鈕：**
   - 看到「更新中...」動畫
   - 狀態自動切換
   - 卡片背景變化

5. **測試前端同步：**
   - 打開前端首頁
   - 點擊「加入購物車」
   - 確認規格選擇器正確過濾

---

**🎉 Toggle 功能完全正常，UI 清晰易懂！** 🚀

**如有任何問題，請查看控制台日誌或參考本指南的「常見問題」章節。**

